/* CoCreateMap */
var CoCreateMap=function(t){this.mapDivSelector=".google_map",this.init(t),this.requireLocationSelector="data-geolocation"};function MapInfo(t,e,a,o){this.lat,this.lng,this.zoom,this.map_id,this.init(t,e,a,o)}function stripHtml(t){var e=document.createElement("div");return e.innerHTML=t,e.textContent||e.innerText||""}function onlyUnique(t,e,a){return a.indexOf(t)===e}CoCreateMap.prototype={mapDivs:[],maps:[],services:[],markers:[],constructor:CoCreateMap,init:function(t){let e=this;if(this.__proto__.mapDivs=document.querySelectorAll(this.mapDivSelector),void 0!==t)this.renderMap(t.mapInfo,t.markerInfo);else{let t=document.querySelector(`[${this.requireLocationSelector}]`),e=!!t&&t.getAttribute(this.requireLocationSelector);if(navigator.geolocation&&"true"==e){let t={timeout:5e3};navigator.geolocation.getCurrentPosition(this.showLocation,this.errHandler,t)}else this.errHandler({code:1})}new MutationObserver(function(t,a){t.forEach(t=>{"attributes"==t.type&&("data-map_lng"==t.attributeName||"data-map_lat"==t.attributeName||"data-map_zoom"==t.attributeName)&&t.target.matches(e.mapDivSelector)&&t.target.attributes["data-map_id"]&&function(t,e){let a=t.target.dataset.map_lat,o=t.target.dataset.map_lng;if(a&&o){let r=t.target.dataset.map_zoom;r||(r=void 0);let i=new MapInfo(t.target.dataset.map_id,o,a,r);e.renderMap(i)}}(t,e)})}).observe(document.body,{attributes:!0,subtree:!0})},showLocation:function(t){let e=t.coords.latitude,a=t.coords.longitude;for(let t of this.mapDivs){let o=new MapInfo(t.dataset.map_id,a,e);this.renderMap(o)}},errHandler:function(t){if(1==t.code)for(let t of this.mapDivs){let e=new MapInfo(t.dataset.map_id);this.renderMap(e)}else 2==t.code&&alert("Error: Position is unavailable!")},renderMap:function(t,e){let a=parseFloat(t.lat),o=parseFloat(t.lng),r=t.zoom,i=t.map_id,n=new google.maps.LatLng(a,o);this.__proto__.maps[i]=new google.maps.Map(document.querySelector(`.google_map[data-map_id='${i}']`),{center:n,zoom:r}),this.__proto__.markers[i]=[],this.__proto__.services[i]=new google.maps.places.PlacesService(this.maps[i]),void 0===e||(void 0==e.option.position&&(e.option.position={lat:a,lng:o}),this.setMarker(i,e.option,e.marker_id))},setMarker:function(t,e,a){return e.map=this.maps[t],void 0!==e.position?void 0===a?(this.markers[t].push(new google.maps.Marker(e)),this.markers[t].length-1):(this.markers[t][a]=new google.maps.Marker(e),a):void 0===a?-1:(delete this.markers[t][a],a)},attToObj:function(t,e="",a=""){let o=document.querySelectorAll(`${a} input[data-${t}]${e}, ${a} input[name]${e}, ${a} textarea[data-${t}]${e}, ${a} textarea[name]${e}`),r={};for(let e of o){let a,o;e.dataset&&(a=e.dataset[t]),a||(a=e.getAttribute("name"));let i=e.getAttribute("type");if("button"!=i&&"submit"!=i&&"reset"!=i&&("radio"==i?o=!!e.checked&&e.value:"checkbox"==i?o=!!e.checked&&(e.getAttribute("value")||!0):e.value&&(o=e.value),o))if(a in r&&"radio"!=i){let t=r[a];Array.isArray(t)?r[a].push(o):(r[a]=[t],r[a].push(o))}else o&&(r[a]=o)}return r},objToAtt:function(t,e,a="",o=""){let r=document.querySelectorAll(`${o} input[data-${e}]${a}, ${o} input[name]${a}, ${o} textarea[data-${e}]${a}, ${o} textarea[name]${a}`);for(let a of r){let o;(o=a.dataset[e])||(o=a.getAttribute("name"));let r=a.getAttribute("type");"button"!=r&&"submit"!=r&&"reset"!=r&&("radio"==r&&o in t?a.checked=t[o]==a.getAttribute("value"):"checkbox"==r&&o in t?a.checked=!!(t[o]==a.getAttribute("value")||Array.isArray(t[o])&&t[o].includes(a.getAttribute("value"))):o in t&&(a.value=t[o]))}}},MapInfo.prototype={constructor:MapInfo,init:function(t=0,e=-74.006,a=40.7128,o=15){this.lat=parseFloat(a),this.lng=parseFloat(e),this.zoom=parseInt(o,10),this.map_id=t}};/* CoCreateMap */
var CoCreateMapAnimate=function(){this.animators=[],this.icon={path:"M29.395,0H17.636c-3.117,0-5.643,3.467-5.643,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759   c3.116,0,5.644-2.527,5.644-5.644V6.584C35.037,3.467,32.511,0,29.395,0z M34.05,14.188v11.665l-2.729,0.351v-4.806L34.05,14.188z    M32.618,10.773c-1.016,3.9-2.219,8.51-2.219,8.51H16.631l-2.222-8.51C14.41,10.773,23.293,7.755,32.618,10.773z M15.741,21.713   v4.492l-2.73-0.349V14.502L15.741,21.713z M13.011,37.938V27.579l2.73,0.343v8.196L13.011,37.938z M14.568,40.882l2.218-3.336   h13.771l2.219,3.336H14.568z M31.321,35.805v-7.872l2.729-0.355v10.048L31.321,35.805",color:"#e50202"},this.mapDivSelector=".google_map",this.init(),this.init=function(){let t=document.querySelectorAll(".google_map[data-map_id]");for(let o of t)this.animators[o.dataset.map_id]={}},this.__proto__.showPosition=function(){navigator.geolocation?this.watchID=navigator.geolocation.watchPosition(t=>{this.showLocation(t)},t=>{this.errHandler(t)},{timeout:5e3}):alert("Sorry, your browser does not support HTML5 geolocation.")},this.showLocation=function(t){this.checkAnimator("simon")||this.__proto__.showLocation(t),this.addAnimator("simon",{lat:t.coords.latitude,lng:t.coords.longitude})},this.errorCallback=function(t){1==t.code?console.log("You've decided not to share your position, but it's OK. We won't ask you again."):2==t.code?console.log("The network is down or the positioning service can't be reached."):3==t.code?console.log("The attempt timed out before it could get the location data."):console.log("Geolocation failed due to unknown error.")},this.checkAnimator=function(t,o=0){return void 0!==this.animators[o][t]},this.removeAnimator=function(t,o=0){this.animators[o][t].marker.setMap(null)},this.addAnimator=function(t,o,i,e=0){i=void 0===i?this.icon:i;if(this.checkAnimator(t))this.animatedMove(t,o);else{let a={path:i.path,scale:.5,fillColor:i.color,fillOpacity:1,strokeWeight:1,anchor:new google.maps.Point(0,5),rotation:0},n=this.setMarker(e,{position:o,icon:a,title:t});this.maps[e].setCenter(this.markers[e][n].getPosition()),this.animators[e][t]={},this.animators[e][t].loc=o,this.animators[e][t].angle=0,this.animators[e][t].timestamp=new Date,this.animators[e][t].marker=this.markers[e][n],this.animators[e][t].icon=i}},this.animatedMove=function(t,o,i=0){let e=this.animators[i][t],a=e.marker,n=e.icon,s=a.position,r=this.bearingBetweenLocations(e.loc,o);o.timestamp||(o.timestamp=new Date);let l=(o.lat-s.lat())/100,c=(o.lng-s.lng())/100,h=this.deltaAngle(r,e.angle)/100,m=o.timestamp.getSeconds()-e.timestamp.getSeconds(),p=e.angle;p=this.currentAngle(p,h);let g=m;for(let t=0;t<100;t++)setTimeout(function(){let t=null,o=null,i=a.position.lat(),e=a.position.lng();i+=l,e+=c,o={path:n.path,scale:.5,fillColor:n.color,fillOpacity:1,strokeWeight:1,anchor:new google.maps.Point(0,5),rotation:p},t=new google.maps.LatLng(i,e),a.setPosition(t),a.setIcon(o)},t*g*10);this.animators[i][t].loc=o,this.animators[i][t].angle=r,this.animators[i][t].timestamp=o.timestamp,this.animators[i][t].marker=a},this.bearingBetweenLocations=function(t,o){let i=180/Math.PI,e=t.lat/i,a=t.lng/i,n=o.lat/i,s=o.lng/i-a,r=Math.sin(s)*Math.cos(n),l=Math.cos(e)*Math.sin(n)-Math.sin(e)*Math.cos(n)*Math.cos(s),c=Math.atan2(r,l);return c=((c*=i)+360)%360},this.deltaAngle=function(t,o){return t-o},this.currentAngle=function(t,o){return t+o<0?360+(t+o):t+o>360?(t+o)%360:t+o},CoCreateMap.call(this)};CoCreateMapAnimate.prototype=Object.create(CoCreateMap.prototype),CoCreateMapAnimate.prototype.constructor=CoCreateMapAnimate;/* CoCreateMap */
var CoCreateMapGetLocation=function(){this.attr="data-geolocation",this.geolocation_html=null,this.init=(()=>{this.ccMapAnimate||(this.ccMapAnimate=new CoCreateMapAnimate),this.geolocation_html=document.querySelector("["+this.attr+"]"),this.geolocation_html&&"true"==this.geolocation_html.getAttribute(this.attr)&&(console.log("initialite map"),this.showPosition()),socket.on("updateDocument",t=>{this.createAnimator(t.data.currentLocation)})}),this.createAnimator=(t=>{this.ccMapAnimate.addAnimator("me",{lat:t.coords.latitude,lng:t.coords.longitude})}),this.saveData=(t=>{try{CoCreate.validateKeysJson(this.geolocation_html.dataset,["collection","document_id"]);let o=this.geolocation_html.dataset.collection||"",e=this.geolocation_html.dataset.document_id||"";""!=o&&""!=e&&(console.log("Saved location in db"),CoCreate.updateDocument({collection:o,document_id:e,data:{currentLocation:this.getPositionAsJSon(t)}}))}catch(t){console.error(t)}}),this.getPositionAsJSon=(t=>({coords:{accuracy:t.coords.accuracy,altitude:t.coords.altitude,altitudeAccuracy:t.coords.altitudeAccuracy,heading:t.coords.heading,latitude:t.coords.latitude,longitude:t.coords.longitude,speed:t.coords.speed},timestamp:t.timestamp})),this.showLocation=(t=>{if(this.prevLat!=t.coords.latitude||this.prevLong!=t.coords.longitude){this.prevLat=t.coords.latitude,this.prevLong=t.coords.longitude,this.saveData(t);var o="Your position is (Latitude: "+t.coords.latitude+", Longitude: "+t.coords.longitude+")";document.getElementById("result").innerHTML=o}}),CoCreateMapAnimate.call(this)};CoCreateMapGetLocation.prototype=Object.create(CoCreateMapAnimate.prototype),CoCreateMapGetLocation.prototype.constructor=CoCreateMapGetLocation;/* CoCreateMap */
var CoCreateMapAutocomplete=function(){this.componentForm={location:"",street_number:"",route:"",locality:"",administrative_area_level_1:"",administrative_area_level_2:"",administrative_area_level_3:"",city:"",country:"",country_code:"",postal_code:"",new_param1:"",new_param2:""},this.mapDivSelector=".google_map",this.autocompleteSelector='[data-map_autocomplete="true"]',this.searchSelector=".main-search",this.init(),this.init=function(){this.initComponentForm(),this.initAutoComplete()},this.initComponentForm=function(){for(var e in this.componentForm){var t=document.querySelector("input[data-place="+e+"]");this.componentForm[e]=t&&t.dataset.place_value_type?t.dataset.place_value_type:"long_name"}},this.initAutoComplete=function(){let e=this,t=document.querySelectorAll("[data-place]"),a=[];for(let e of t)a.push(e.dataset.place_id);let o={address:"address",administrative_area_level_2:"(cities)",region_country:"(regions)",establishment:"establishment"};(a=a.filter(onlyUnique)).forEach(function(t,a){let i=t,n=document.querySelectorAll(`${e.autocompleteSelector}[data-place_id='${i}']`);n.forEach(function(t,a){let i,l=t.dataset.place;void 0!==o[l]&&(i=new google.maps.places.Autocomplete(n.item(a),{types:[o[l]]})),t.matches(e.searchSelector)&&i.addListener("place_changed",function(){let a=i.getPlace(),o={};o.place_id=t.dataset.place_id,o.google_place_id=a.place_id,o.address_components=a.address_components,a.adr_address&&(o.adr_address=stripHtml(a.adr_address)),o.longitude=a.geometry.location.lng(),o.latitude=a.geometry.location.lat(),o.show_map="destination"!=t.dataset.direction||"false"==t.dataset.autodirection,e.renderAutoComplete(o)})})})},this.objToAtt=function(e,t,a="",o=""){let i={};for(let t in e)if("address_components"==t)for(let a of e[t]){let e=a.types[0];i[e]=a.long_name,"country"==e&&(i.country_code=a.short_name,i.region_country=a.long_name),"administrative_area_level_1"!=e||i.administrative_area_level_2||(i.administrative_area_level_2=a.long_name)}else if("adr_address"==t)i.address=e[t];else{if("place_id"==t)continue;"google_place_id"==t?i.place_id=e[t]:i[t]=e[t]}this.__proto__.objToAtt(i,t,a,o)},this.renderAutoComplete=function(e){let t=e.place_id;this.objToAtt(e,"place",`[data-place_id='${t}']`);let a=document.querySelector(`[data-place='longitude'][data-place_id='${t}']`),o=document.querySelector(`[data-place='latitude'][data-place_id='${t}']`);if(a&&o)if("createEvent"in document){var i=document.createEvent("HTMLEvents");i.initEvent("change",!1,!0),a.dispatchEvent(i),o.dispatchEvent(i)}else a.fireEvent("onchange"),o.fireEvent("onchange");if(e.show_map){var n=document.querySelector(`[data-place_id='${t}']`).dataset.map_id,l=document.querySelector(`${this.mapDivSelector}[data-map_id='${n}']`);l&&(l.dataset.map_lng=e.longitude,l.dataset.map_lat=e.latitude)}},CoCreateMap.call(this)};CoCreateMapAutocomplete.prototype=Object.create(CoCreateMap.prototype),CoCreateMapAutocomplete.prototype.constructor=CoCreateMapAutocomplete;/* CoCreateMap */
var CoCreateMapDirection=function(){this.isDirectionShowing=!1,this.init(),this.init=function(){let t=this;document.querySelectorAll("[data-direction='destination'][data-map_id][data-place='longitude'], [data-direction='destination'][data-map_id][data-place='latitude']").forEach(function(e,i){e.addEventListener("change",function(i){let a=e.dataset.map_id;t.prepareDirection(a)})}),document.querySelectorAll(".direction_option:not([data-autodirection='false']) input[data-direction]").forEach(function(e,i){e.addEventListener("change",function(i){let a=e.dataset.map_id;t.prepareDirection(a)})}),document.querySelectorAll("input[data-direction='waypoint']").forEach(function(e,i){e.addEventListener("change",function(i){let a=e.dataset.map_id,n=e.dataset.place_id;t.isDirectionShowing&&(t.clearAll.clearAll(`input[data-direction='waypoint'][data-map_id='${a}']:not([data-place_id='${n}'])`),t.isDirectionShowing=!1)})})},this.attToObj=function(t,e,i){let a=this.__proto__.attToObj(t,e,i),n={};for(let t in a)"arrivalTime"==t||"routingPreference"==t?(n.transitOptions=n.transitOptions||{},n.transitOptions[t]=a[t]):"t_departureTime"==t?(n.transitOptions=n.transitOptions||{},n.transitOptions.departureTime=a[t]):"transit_modes"==t?(n.transitOptions=n.transitOptions||{},n.transitOptions.modes=a[t]):"d_departureTime"==t?(n.drivingOptions=n.drivingOptions||{},n.drivingOptions.departureTime=a[t]):"trafficModel"==t?(n.drivingOptions=n.drivingOptions||{},n.drivingOptions[t]=a[t]):n[t]=a[t];return n},this.prepareDirection=function(t){const e=this,i=document.querySelectorAll(`[data-direction='waypoint'][data-map_id='${t}'][data-place='longitude'], [data-direction='waypoint'][data-map_id='${t}'][data-place='latitude']`);var a=[],n=[];for(var o of i)if(o.value){var r=o.dataset.place_id;a[r]?("latitude"==o.dataset.place?n.push({lat:o.value,lng:a[r]}):n.push({lat:a[r],lng:o.value}),delete a[r]):a[r]=o.value}console.log(i);var d=document.querySelector(`[data-direction='origin'][data-place='longitude'][data-map_id='${t}']`).value,l=document.querySelector(`[data-direction='origin'][data-place='latitude'][data-map_id='${t}']`).value,s=document.querySelector(`[data-direction='destination'][data-place='longitude'][data-map_id='${t}']`).value,p=document.querySelector(`[data-direction='destination'][data-place='latitude'][data-map_id='${t}']`).value;if(d&&l&&s&&p){const i=this.maps[t].getCenter(),a=this.maps[t].getZoom();this.maps[t]=new google.maps.Map(document.querySelector(`.google_map[data-map_id='${t}']`),{center:i,zoom:a});let o=this.attToObj("direction",`[data-map_id='${t}']`,".direction_option"),r={...{map_id:t,origin:{lat:l,lng:d},destination:{lat:p,lng:s},waypoints:n,travelMode:"DRIVING"},...o};e.renderDirection(r)}},this.renderDirection=function(t){let e=new google.maps.DirectionsService,i=new google.maps.DirectionsRenderer({draggable:!0}),a={};for(let e in t){let i=t[e];if("map_id"!=e)if("origin"==e||"destination"==e)a[e]={},a[e]=new google.maps.LatLng(i.lat,i.lng);else if("waypoints"==e){a[e]=[];for(let t of i)a[e].push({location:new google.maps.LatLng(t.lat,t.lng)})}else if("transitOptions"==e){let t={};i.arrivalTime&&(t.arrivalTime=new Date(i.arrivalTime)),i.departureTime&&(t.departureTime=new Date(i.departureTime)),i.modes&&(t.modes=i.modes),i.routingPreference&&(t.routingPreference=i.routingPreference),a[e]=t}else if("drivingOptions"==e){let t={};i.departureTime&&(t.departureTime=new Date(i.departureTime)),t.trafficModel=i.trafficModel,a[e]=t}else a[e]="unitSystem"==e?"METRIC"==i.unitSystem?google.maps.UnitSystem.METRIC:google.maps.UnitSystem.IMPERIAL:i}i.setMap(this.maps[t.map_id]),console.log(a),e.route(a,function(t,e){"OK"==e?(i.setDirections(t),this.isDirectionShowing=!0):alert("No result!")})},CoCreateMap.call(this)};CoCreateMapDirection.prototype=Object.create(CoCreateMap.prototype),CoCreateMapDirection.prototype.constructor=CoCreateMapDirection;/* CoCreateMap */
var CoCreateMapSearch=function(){this.init(),this.init=function(){var e=this;document.querySelectorAll(".search").forEach(a=>{a.addEventListener("click",function(){let a=this.dataset.map_id;e.search(e,a)})})},this.search=function(e,a){let t=document.querySelector(`[data-map_id='${a}'][name='searchType']:checked`).value,o=document.querySelector(`[data-map_id='${a}'][name='locationBias']:checked`).value,i=this.attToObj("option_attribute",`[data-map_id='${a}']`),r={};"searchFromQuery"==t||"searchFromPhoneNumber"==t?(r={fields:["All"]},"LatLng"==o&&i.latitude&&i.longitude?r.locationBias={lat:parseFloat(i.latitude),lng:parseFloat(i.longitude)}:"LatLngBounds"==o?r.locationBias=e.maps[a].getBounds():"Radius"==o&&(r.locationBias={radius:parseInt(i.radius,10),center:{lat:parseFloat(i.latitude),lng:parseFloat(i.longitude)}}),"searchFromQuery"==t?(r.query=i.query,e.searchFromQuery(r,a)):(r.phoneNumber=i.query,e.searchFromPhoneNumber(r,a)),console.log(r)):"searchNearBy"==t?(r={keyword:i.query},"LatLngBounds"==o?r.bounds=e.maps[a].getBounds():"Radius"==o&&(r.location={lat:parseFloat(i.latitude),lng:parseFloat(i.longitude)},r.radius=parseInt(i.radius,10)),i.keyword&&(r.keyword=i.keyword),i.minPriceLevel&&(r.minPriceLevel=i.minPriceLevel),i.maxPriceLevel&&(r.maxPriceLevel=i.maxPriceLevel),i.name&&(r.name=i.name),i.openNow&&(r.openNow=i.openNow),i.rankBy&&(r.rankBy=google.maps.places.RankBy.DISTANCE),console.log(r),e.searchNearBy(r,a)):"searchText"==t&&(r={query:i.query},"LatLngBounds"==o?r.bounds=e.maps[a].getBounds():"Radius"==o&&(r.location=new google.maps.LatLng({lat:parseFloat(i.latitude),lng:parseFloat(i.longitude)}),r.radius=parseInt(i.radius)),i.openNow&&(r.openNow=i.openNow),i.minPriceLevel&&(r.minPriceLevel=i.minPriceLevel),i.maxPriceLevel&&(r.maxPriceLevel=i.maxPriceLevel),e.searchText(r,a))},this.searchFromQuery=function(e,a){let t=this;this.services[a].findPlaceFromQuery(e,function(e,o){if(o===google.maps.places.PlacesServiceStatus.OK){let o={placeId:e[0].place_id};t.findDetails(o,a)}})},this.searchFromPhoneNumber=function(e,a){let t=this;this.services[a].findPlaceFromPhoneNumber(e,function(e,o){if(o===google.maps.places.PlacesServiceStatus.OK){let o={placeId:e[0].place_id};t.findDetails(o,a)}})},this.searchNearBy=function(e,a){let t=this;this.services[a].nearbySearch(e,function(e,o){if(o===google.maps.places.PlacesServiceStatus.OK){console.log(e);for(let o of e){let e={placeId:o.place_id};t.findDetails(e,a)}}})},this.searchText=function(e,a){let t=this;this.services[a].textSearch(e,function(e,o){if(o===google.maps.places.PlacesServiceStatus.OK){console.log(e);for(let o of e){let e={placeId:o.place_id};t.findDetails(e,a)}}})},this.findDetails=function(e,a){let t=this;console.log(e),this.services[a].getDetails(e,function(e,o){if(o===google.maps.places.PlacesServiceStatus.OK){let o=e.geometry.location;t.createMarker(o,a)}})},CoCreateMap.call(this)};CoCreateMapSearch.prototype=Object.create(CoCreateMap.prototype),CoCreateMapSearch.prototype.constructor=CoCreateMapSearch;/* CoCreateMap */
function initMapSettings(){var t=new CoCreateMapAutocomplete;new CoCreateMapDirection,new CoCreateMapSearch,new CoCreateMapGetLocation;initSortableSettings(t)}function initSortableSettings(t){new MutationObserver(function(e){e.forEach(function(e){if("childList"==e.type&&e.target.classList.contains("Sortable")&&e.target.classList.contains("waypoints")&&1==e.addedNodes.length){var a=e.addedNodes.item(0),i=a.querySelectorAll("[data-place_id]");for(var o of i)o.setAttribute("data-place_id",a.getAttribute("prefix"));console.log(t),t.init()}})}).observe(document.body,{attribute:!1,childList:!0,characterData:!1,subtree:!0})}